name: Terraform CI Pipeline

'on':
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - '**.tfvars'
      - '**.hcl'
      - '.github/workflows/terraform-ci.yml'
      - '.tflint.hcl'
  push:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - '**.tfvars'
      - '**.hcl'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TERRAFORM_VERSION: '1.9.8'
  TFLINT_VERSION: 'v0.50.3'
  TFSEC_VERSION: 'v1.28.5'
  CHECKOV_VERSION: '3.2.0'

jobs:
  # =============================================================================
  # Job 1: Validation and Formatting
  # =============================================================================
  validate:
    name: Terraform Validate & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          # Find directories with .tf files, excluding modules
          find . -type f -name "*.tf" -not -path "*/modules/*" \
            -exec dirname {} \; | sort -u | while read dir; do
            if [ -f "$dir/versions.tf" ] || \
               [ -f "$dir/main.tf" ] || \
               [ -f "$dir/provider.tf" ]; then
              echo "Initializing $dir"
              cd "$GITHUB_WORKSPACE/$dir"
              terraform init -backend=false || echo "‚ö†Ô∏è Init failed for $dir"
            fi
          done
        continue-on-error: false

      - name: Terraform Validate
        id: validate
        run: |
          # Find directories with .tf files, excluding modules
          find . -type f -name "*.tf" -not -path "*/modules/*" \
            -exec dirname {} \; | sort -u | while read dir; do
            if [ -f "$dir/versions.tf" ] || \
               [ -f "$dir/main.tf" ] || \
               [ -f "$dir/provider.tf" ]; then
              echo "Validating $dir"
              cd "$GITHUB_WORKSPACE/$dir"
              terraform validate || echo "‚ö†Ô∏è Validation failed for $dir"
            fi
          done

      - name: Comment PR - Validation
        if: >-
          github.event_name == 'pull_request' &&
          (steps.fmt.outcome == 'failure' ||
          steps.validate.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Format and Style üñå\
            \`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\
            \`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\
            \`${{ steps.validate.outcome }}\`

            *Pushed by: @${{ github.actor }}, \
            Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # =============================================================================
  # Job 2: TFLint - Terraform Linting
  # =============================================================================
  tflint:
    name: TFLint Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache TFLint Plugin Directory
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Show TFLint Version
        run: tflint --version

      - name: Init TFLint
        run: |
          tflint --init \
            --config="${GITHUB_WORKSPACE}/.tflint.hcl"

      - name: Run TFLint
        id: tflint
        run: |
          tflint \
            --config="${GITHUB_WORKSPACE}/.tflint.hcl" \
            --format=compact \
            --recursive \
            --force
        continue-on-error: true

      - name: Comment PR - TFLint
        if: >-
          github.event_name == 'pull_request' &&
          steps.tflint.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### TFLint üìù\`${{ steps.tflint.outcome }}\`

            <details><summary>Show TFLint Results</summary>

            \`\`\`
            ${{ steps.tflint.outputs.stdout }}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # =============================================================================
  # Job 3: Security Scanning with Checkov
  # =============================================================================
  checkov:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov==${{ env.CHECKOV_VERSION }}

      - name: Run Checkov
        id: checkov
        run: |
          checkov --directory . \
                  --framework terraform \
                  --output cli \
                  --output json \
                  --output-file-path \
                    console,checkov-report.json \
                  --quiet \
                  --skip-check CKV_AWS_119,CKV_AWS_28
        continue-on-error: true

      - name: Upload Checkov Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json
          retention-days: 30

      - name: Comment PR - Checkov
        if: >-
          github.event_name == 'pull_request' &&
          steps.checkov.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'Failed to load Checkov summary';

            try {
              const report = JSON.parse(
                fs.readFileSync('checkov-report.json', 'utf8')
              );
              const summary_data = report.summary || {};
              summary = `
              - Passed: ${summary_data.passed || 0}
              - Failed: ${summary_data.failed || 0}
              - Skipped: ${summary_data.skipped || 0}
              `;
            } catch (e) {
              console.error(
                'Error reading Checkov report:', e
              );
            }

            const output = `#### Checkov Security Scan üîí\
            \`${{ steps.checkov.outcome }}\`

            <details><summary>Show Summary</summary>

            ${summary}

            </details>

            *Download full report from workflow artifacts*
            *Pushed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # =============================================================================
  # Job 4: Security Scanning with tfsec
  # =============================================================================
  tfsec:
    name: tfsec Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run tfsec
        id: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          version: ${{ env.TFSEC_VERSION }}
          soft_fail: true
          format: sarif
          additional_args: >-
            --exclude-downloaded-modules
            --minimum-severity=MEDIUM

      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
        continue-on-error: true

      - name: Run tfsec (CLI output)
        run: |
          docker run --rm \
            -v "$(pwd):/src" \
            aquasec/tfsec:${{ env.TFSEC_VERSION }} \
            /src \
            --exclude-downloaded-modules \
            --minimum-severity=MEDIUM \
            --format=default
        continue-on-error: true

  # =============================================================================
  # Job 5: YAML Linting
  # =============================================================================
  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint --format parsable --strict . || true

  # =============================================================================
  # Job 6: Documentation Check
  # =============================================================================
  terraform-docs:
    name: Terraform Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Render terraform docs
        uses: terraform-docs/gh-actions@v1.1.0
        with:
          working-dir: .
          output-file: README.md
          output-method: inject
          git-push: false
          recursive: true
          recursive-path: modules

  # =============================================================================
  # Job 7: Cost Estimation with Infracost
  # =============================================================================
  infracost:
    name: Cost Estimation
    runs-on: ubuntu-latest
    # CR√çTICO: S√≥ roda em Pull Requests
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost cost estimate baseline
        run: |
          infracost breakdown --path=. \
            --format=json \
            --out-file=/tmp/infracost-base.json

      - name: Generate Infracost diff
        run: |
          infracost diff --path=. \
            --format=json \
            --compare-to=/tmp/infracost-base.json \
            --out-file=/tmp/infracost.json

      - name: Post Infracost comment
        if: github.event.pull_request.number != ''
        run: |
          infracost comment github \
            --path=/tmp/infracost.json \
            --repo=$GITHUB_REPOSITORY \
            --github-token=${{ github.token }} \
            --pull-request=${{ github.event.pull_request.number }} \
            --behavior=update

  # =============================================================================
  # Job 8: Summary and Gate
  # =============================================================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validate, tflint, checkov, tfsec, yamllint, infracost]
    if: always()
    steps:
      - name: Check Job Results
        run: |
          echo "Validation: ${{ needs.validate.result }}"
          echo "TFLint: ${{ needs.tflint.result }}"
          echo "Checkov: ${{ needs.checkov.result }}"
          echo "tfsec: ${{ needs.tfsec.result }}"
          echo "YAML Lint: ${{ needs.yamllint.result }}"
          echo "Infracost: ${{ needs.infracost.result }}"

      - name: Evaluate Pipeline
        run: |
          # Critical failures (block merge)
          if [[ "${{ needs.validate.result }}" == "failure" ]]; then
            echo "‚ùå Terraform validation failed"
            exit 1
          fi

          # Warnings (don't block merge)
          if [[ "${{ needs.tflint.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  TFLint found issues"
          fi

          if [[ "${{ needs.checkov.result }}" == "failure" ]] || \
             [[ "${{ needs.tfsec.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  Security scans found issues - review required"
          fi

          if [[ "${{ needs.infracost.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  Infracost analysis failed"
          fi

          echo "‚úÖ Pipeline completed - Review results above"
