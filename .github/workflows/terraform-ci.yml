name: Terraform CI

on:
  pull_request:
    branches: [main, developer]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '**.hcl'
      - '.github/workflows/terraform-ci.yml'
      - '.tflint.hcl'
  push:
    branches: [main, developer]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '**.hcl'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TERRAFORM_VERSION: '1.10.5'
  TFLINT_VERSION: 'v0.55.1'       # Atualizado â€” v0.50 estÃ¡ 6+ meses atrÃ¡s
  CHECKOV_VERSION: '3.2.350'       # Pin exato para reprodutibilidade
  AWS_REGION: 'us-east-1'

# =============================================================================
# Job 1: Lint & Format
# =============================================================================
jobs:
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # Cache de providers â€” compartilhado com o job validate
      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            **/.terraform/providers
          key: tf-providers-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: tf-providers-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      # Init sem backend â€” baixa mÃ³dulos externos para que TFLint consiga resolvÃª-los
      - name: Terraform Init (no backend)
        run: terraform init -backend=false -input=false -no-color

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ runner.os }}-${{ hashFiles('.tflint.hcl') }}
          restore-keys: tflint-${{ runner.os }}-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init --config="${GITHUB_WORKSPACE}/.tflint.hcl"

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: TFLint
        id: tflint
        run: |
          tflint \
            --config="${GITHUB_WORKSPACE}/.tflint.hcl" \
            --format=compact \
            --recursive \
            --force 2>&1 | tee tflint_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Comment PR â€” Lint & Format
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          FMT_OUTCOME: ${{ steps.fmt.outcome }}
          TFLINT_OUTCOME: ${{ steps.tflint.outcome }}
        with:
          script: |
            const fmtStatus    = process.env.FMT_OUTCOME;
            const tflintStatus = process.env.TFLINT_OUTCOME;
            const fmtIcon      = fmtStatus    === 'success' ? 'âœ…' : 'âŒ';
            const tflintIcon   = tflintStatus === 'success' ? 'âœ…' : 'âš ï¸';

            const body = [
              '## ğŸ” Terraform Lint & Format',
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| Terraform Format | ${fmtIcon} \`${fmtStatus}\` |`,
              `| TFLint | ${tflintIcon} \`${tflintStatus}\` |`,
              '',
              fmtStatus !== 'success'
                ? '> ğŸ’¡ Execute `terraform fmt -recursive` localmente e faÃ§a commit.'
                : '',
              '',
              `_Commit: \`${{ github.sha }}\`_`,
            ].filter(Boolean).join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## ğŸ” Terraform Lint & Format';
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            };

            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

      - name: Evaluate results
        run: |
          if [[ "${{ steps.fmt.outcome }}" == "failure" ]]; then
            echo "::error::terraform fmt falhou. Execute 'terraform fmt -recursive' e faÃ§a commit."
            exit 1
          fi
          echo "âœ… Lint & Format OK"

# =============================================================================
# Job 2: Validate (Sintaxe)
# =============================================================================
  validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            **/.terraform/providers
          key: tf-providers-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: tf-providers-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      # Init sem backend â€” valida sintaxe sem precisar de credenciais AWS
      - name: Terraform Init (no backend)
        run: terraform init -backend=false -input=false -no-color

      # NOTA: validate sem -var-file pode falhar com mÃ³dulos que usam default=null
      # em condiÃ§Ãµes de validaÃ§Ã£o (Terraform nÃ£o faz short-circuit). Resultado Ã©
      # tratado como warning, nÃ£o bloqueante. ValidaÃ§Ã£o real acontece no plan (CD).
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color 2>&1 | tee validate_output.txt

      - name: Comment PR â€” Validate
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
          VALIDATE_STDOUT: ${{ steps.validate.outputs.stdout }}
        with:
          script: |
            const fs = require('fs');
            const status = process.env.VALIDATE_OUTCOME;
            const icon   = status === 'success' ? 'âœ…' : 'âš ï¸';

            let output = '';
            try {
              output = fs.readFileSync('validate_output.txt', 'utf8').trim();
            } catch (e) {
              output = process.env.VALIDATE_STDOUT || 'Sem output disponÃ­vel';
            }

            // Trunca output longo para nÃ£o estourar limite do GitHub API (65536 chars)
            const MAX_LEN = 3000;
            if (output.length > MAX_LEN) {
              output = output.substring(0, MAX_LEN) + '\n\n... (truncado)';
            }

            const isModuleError = status === 'failure' &&
              (output.includes('modules/') && (output.includes('null') || output.includes('default')));

            const note = isModuleError
              ? '\n> âš ï¸ PossÃ­vel falha por `default = null` em mÃ³dulo â€” nÃ£o bloqueante. ValidaÃ§Ã£o completa ocorre no plan.'
              : '';

            const body = [
              '## âš™ï¸ Terraform Validate',
              '',
              `**Status:** ${icon} \`${status}\`${note}`,
              '',
              '<details><summary>Ver output</summary>',
              '',
              '```',
              output,
              '```',
              '</details>',
              '',
              `_Commit: \`${{ github.sha }}\`_`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## âš™ï¸ Terraform Validate';
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            const params = { owner: context.repo.owner, repo: context.repo.repo, body };

            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

# =============================================================================
# Job 3: Security Scanning (Checkov + Trivy)
# =============================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ Checkov â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-checkov-${{ env.CHECKOV_VERSION }}

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.base_ref }}" == "main" || "${{ github.ref_name }}" == "main" ]]; then
            echo "ENV_NAME=prod" >> $GITHUB_OUTPUT
          else
            echo "ENV_NAME=dev" >> $GITHUB_OUTPUT
          fi

      - name: Install Checkov
        run: pip install checkov==${{ env.CHECKOV_VERSION }} --quiet

      - name: Run Checkov
        id: checkov
        run: |
          checkov \
            --directory . \
            --framework terraform \
            --download-external-modules true \
            --var-file envs/${{ steps.env.outputs.ENV_NAME }}/terraform.tfvars \
            --output cli \
            --output json \
            --output-file-path console,checkov-report.json \
            --quiet \
            --compact \
            --skip-check CKV_AWS_119,CKV_AWS_28 \
            2>&1 | tee checkov_output.txt

          # Captura o exit code do Checkov (o primeiro comando do pipe)
          CHECKOV_EXIT_CODE=${PIPESTATUS[0]}
          
          echo "exitcode=$CHECKOV_EXIT_CODE" >> "$GITHUB_OUTPUT"
          
          # Se o cÃ³digo for diferente de 0, o script encerra aqui e falha o step
          if [ $CHECKOV_EXIT_CODE -ne 0 ]; then
            echo "âŒ Checkov encontrou falhas crÃ­ticas de seguranÃ§a."
            exit $CHECKOV_EXIT_CODE
          fi
      - name: Upload Checkov report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report-${{ github.sha }}
          path: checkov-report.json
          retention-days: 30
          if-no-files-found: warn

      # â”€â”€ Trivy (substitui tfsec â€” deprecated desde 2023) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Os findings de misconfig ainda sÃ£o vÃ¡lidos para anÃ¡lise estÃ¡tica.
      - name: Setup Terraform (for Trivy module resolution)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init (no backend)
        run: terraform init -backend=false -input=false -no-color



      - name: Generate Trivy Config
        run: |
          cat > trivy.yaml << EOF
          misconfiguration:
            terraform:
              vars:
                - envs/${{ steps.env.outputs.ENV_NAME }}/terraform.tfvars
          EOF
          cat trivy.yaml

      - name: Run Trivy IaC scanner (Table)
        id: trivy
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          trivy-config: trivy.yaml
          severity: 'MEDIUM,HIGH,CRITICAL'
          exit-code: '1'
          format: 'table'
          output: 'trivy_output.txt'
          version: 'v0.69.1'
          skip-dirs: '.external_modules,.terraform'
        continue-on-error: true

      - name: Trivy SARIF report
        if: always()
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          trivy-config: trivy.yaml
          severity: 'MEDIUM,HIGH,CRITICAL'
          format: 'sarif'
          output: 'trivy-results.sarif'
          skip-setup-trivy: true
          version: 'v0.69.1'
          skip-dirs: '.external_modules,.terraform'
        continue-on-error: true
      - name: Upload Trivy SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4.32.3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-iac
        continue-on-error: true

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports-${{ github.sha }}
          path: |
            trivy_output.txt
            trivy-results.sarif
          retention-days: 30
          if-no-files-found: warn

      # â”€â”€ ComentÃ¡rio consolidado no PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment PR â€” Security
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          CHECKOV_OUTCOME: ${{ steps.checkov.outcome }}
          TRIVY_OUTCOME: ${{ steps.trivy.outcome }}
        with:
          script: |
            const fs = require('fs');

            const checkovStatus = process.env.CHECKOV_OUTCOME;
            const trivyStatus   = process.env.TRIVY_OUTCOME;

            // Parse seguro do relatÃ³rio Checkov
            let checkovSummary = '_RelatÃ³rio nÃ£o disponÃ­vel_';
            try {
              const raw = fs.readFileSync('checkov-report.json', 'utf8');
              const report = JSON.parse(raw);
              const results = Array.isArray(report) ? report : [report];
              const s = results.reduce((acc, r) => {
                const summary = r?.summary || {};
                acc.passed  += summary.passed  || 0;
                acc.failed  += summary.failed  || 0;
                acc.skipped += summary.skipped || 0;
                return acc;
              }, { passed: 0, failed: 0, skipped: 0 });
              checkovSummary = `âœ… ${s.passed} passed Â· âŒ ${s.failed} failed Â· â­ï¸ ${s.skipped} skipped`;
            } catch (e) {
              console.log(`Checkov report parse error: ${e.message}`);
            }

            // Trivy summary
            let trivySummary = '_RelatÃ³rio nÃ£o disponÃ­vel_';
            try {
              const trivyOutput = fs.readFileSync('trivy_output.txt', 'utf8');
              const lines = trivyOutput.split('\n');
              const totalLine = lines.find(l => l.includes('Total:'));
              trivySummary = totalLine ? totalLine.trim() : (trivyStatus === 'success' ? 'Nenhum finding' : 'Ver output');
            } catch (e) {
              trivySummary = trivyStatus === 'success' ? 'Nenhum finding' : 'Ver aba Security';
            }

            const icon = (s) => s === 'success' ? 'âœ…' : 'âš ï¸';

            const body = [
              '## ğŸ”’ Security Scanning',
              '',
              '| Scanner | Status | Detalhes |',
              '|---------|--------|----------|',
              `| Checkov | ${icon(checkovStatus)} \`${checkovStatus}\` | ${checkovSummary} |`,
              `| Trivy   | ${icon(trivyStatus)} \`${trivyStatus}\`   | ${trivySummary} |`,
              '',
              '> Findings de seguranÃ§a sÃ£o **warnings** â€” nÃ£o bloqueiam merge, mas exigem revisÃ£o.',
              '> Resultados detalhados disponÃ­veis na aba **Security** do repositÃ³rio.',
              '',
              `_Commit: \`${{ github.sha }}\`_`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## ğŸ”’ Security Scanning';
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            const params = { owner: context.repo.owner, repo: context.repo.repo, body };

            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

# =============================================================================
# Job 4: Plan Preview (apenas PRs â€” mostra impacto antes do merge)
# =============================================================================
  plan-preview:
    name: Plan Preview (${{ matrix.env_name }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'
    needs: [lint-format, validate]

    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: main
            env_name: prod
          - branch: developer
            env_name: dev

    # SÃ³ roda plan do ambiente correspondente Ã  branch-alvo do PR
    # Ex: PR para main â†’ plan de prod; PR para developer â†’ plan de dev
    # A expressÃ£o usa contains() porque github.base_ref pode ter prefixo refs/
    env:
      SHOULD_RUN: ${{ contains(github.base_ref, matrix.branch) }}

    steps:
      - name: Skip if not target env
        if: env.SHOULD_RUN != 'true'
        run: echo "â­ï¸ Skipping plan for ${{ matrix.env_name }} â€” PR target is ${{ github.base_ref }}"

      - name: Checkout
        if: env.SHOULD_RUN == 'true'
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        if: env.SHOULD_RUN == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        if: env.SHOULD_RUN == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform providers
        if: env.SHOULD_RUN == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            **/.terraform/providers
          key: tf-providers-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: tf-providers-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        if: env.SHOULD_RUN == 'true'
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Init
        if: env.SHOULD_RUN == 'true'
        run: |
          terraform init \
            -backend-config="envs/${{ matrix.env_name }}/backend.hcl" \
            -reconfigure \
            -input=false \
            -no-color

      - name: Terraform Plan
        if: env.SHOULD_RUN == 'true'
        id: plan
        run: |
          set +e
          terraform plan \
            -var-file="envs/${{ matrix.env_name }}/terraform.tfvars" \
            -detailed-exitcode \
            -input=false \
            -no-color 2>&1 | tee plan_output.txt

          EXIT_CODE=${PIPESTATUS[0]}

          case $EXIT_CODE in
            0) echo "has_changes=false" >> "$GITHUB_OUTPUT" ;;
            1) echo "has_changes=error" >> "$GITHUB_OUTPUT"; exit 1 ;;
            2) echo "has_changes=true"  >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Comment PR â€” Plan Preview
        if: env.SHOULD_RUN == 'true' && always()
        uses: actions/github-script@v7
        env:
          HAS_CHANGES: ${{ steps.plan.outputs.has_changes }}
          ENV_NAME: ${{ matrix.env_name }}
        with:
          script: |
            const fs = require('fs');
            const envName = process.env.ENV_NAME;
            const hasChanges = process.env.HAS_CHANGES;

            let planOutput = '_Plan output nÃ£o disponÃ­vel_';
            try {
              planOutput = fs.readFileSync('plan_output.txt', 'utf8').trim();
            } catch (e) {}

            // Trunca para respeitar limite de 65536 chars da API
            const MAX = 50000;
            if (planOutput.length > MAX) {
              planOutput = planOutput.substring(0, MAX) + '\n\n... (truncado â€” ver logs do CI para output completo)';
            }

            let statusLine;
            if (hasChanges === 'true') {
              statusLine = 'ğŸ”„ **MudanÃ§as detectadas** â€” review o plan abaixo antes de aprovar.';
            } else if (hasChanges === 'error') {
              statusLine = 'âŒ **Plan falhou** â€” corrija os erros antes do merge.';
            } else {
              statusLine = 'âœ… **Sem mudanÃ§as** â€” infraestrutura jÃ¡ estÃ¡ no estado desejado.';
            }

            const body = [
              `## ğŸ“‹ Plan Preview â€” \`${envName}\``,
              '',
              statusLine,
              '',
              '<details><summary>Ver plan completo</summary>',
              '',
              '```hcl',
              planOutput,
              '```',
              '</details>',
              '',
              `_Commit: \`${{ github.sha }}\`_`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = `## ğŸ“‹ Plan Preview â€” \`${envName}\``;
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            const params = { owner: context.repo.owner, repo: context.repo.repo, body };

            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

# =============================================================================
# Job 5: Terraform Docs
# =============================================================================
  docs:
    name: Terraform Docs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Check terraform-docs
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: .
          output-file: README.md
          output-method: inject
          git-push: true
        continue-on-error: true

# =============================================================================
# Job 6: CI Gate â€” portÃ£o bloqueante final
# =============================================================================
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint-format, validate, security]
    if: always()

    steps:
      - name: Evaluate gate
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   RESULTADOS DO CI"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Lint & Format : ${{ needs.lint-format.result }}"
          echo "  Validate      : ${{ needs.validate.result }} (aviso)"
          echo "  Security      : ${{ needs.security.result }} (aviso)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          BLOCKING_FAILED=false

          if [[ "${{ needs.lint-format.result }}" == "failure" ]]; then
            echo "::error::BLOQUEANTE: Lint & Format falhou"
            BLOCKING_FAILED=true
          fi

          # Validate: warning apenas (limitaÃ§Ã£o de mÃ³dulos com default=null)
          if [[ "${{ needs.validate.result }}" == "failure" ]]; then
            echo "::warning::Validate reportou problemas â€” pode ser limitaÃ§Ã£o de mÃ³dulos com null"
          fi

          # Security: warning â€” nÃ£o bloqueia merge mas exige revisÃ£o
          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "::warning::Security scan encontrou findings â€” revisÃ£o obrigatÃ³ria"
          fi

          if [[ "$BLOCKING_FAILED" == "true" ]]; then
            echo "::error::CI falhou. Corrija os erros acima."
            exit 1
          fi

          echo "âœ… CI passou â€” cÃ³digo aprovado para deploy."

      - name: Summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          ICON=$([[ "$STATUS" == "success" ]] && echo "âœ… Passou" || echo "âŒ Falhou")

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ### CI Pipeline â€” ${ICON}

          | Job | Resultado | Tipo |
          |-----|-----------|------|
          | Lint & Format | \`${{ needs.lint-format.result }}\` | ğŸ”’ Bloqueante |
          | Validate      | \`${{ needs.validate.result }}\`    | ğŸ”’ Bloqueante  |
          | Security      | \`${{ needs.security.result }}\`    | ğŸ”’ Bloqueante  |

          _Branch: \`${{ github.ref_name }}\` Â· Commit: \`${{ github.sha }}\`_
          EOF
